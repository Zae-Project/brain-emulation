<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Documentation 7 · Simulation Pipeline & Runtime</title>
    <style>
      :root {
        --bg: #16100c;
        --surface: #26190f;
        --accent: #a67b5b;
        --accent-soft: rgba(166, 123, 91, 0.18);
        --text: #f7eddc;
        --text-muted: #d3ba9e;
        --border: rgba(166, 123, 91, 0.35);
        --code-bg: #382414;
      }

      body {
        margin: 0;
        padding: 32px 20px 56px;
        background: var(--bg);
        color: var(--text);
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        line-height: 1.65;
        max-width: 960px;
        margin-inline: auto;
      }

      h1,
      h2,
      h3 {
        color: var(--accent);
        letter-spacing: 0.02em;
        margin-top: 32px;
      }

      h1 {
        font-size: 30px;
        margin-bottom: 18px;
      }

      h2 {
        font-size: 24px;
        margin-bottom: 14px;
      }

      h3 {
        font-size: 20px;
        margin-bottom: 10px;
      }

      p {
        margin: 0 0 16px 0;
      }

      code {
        background: var(--code-bg);
        color: var(--accent);
        padding: 3px 6px;
        border-radius: 4px;
        font-family: "JetBrains Mono", Consolas, monospace;
        font-size: 0.95em;
      }

      pre {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        overflow-x: auto;
        color: var(--text);
      }

      .step {
        border-left: 3px solid var(--border);
        padding-left: 16px;
        margin: 18px 0;
      }

      .callout {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 18px 20px;
        margin: 24px 0;
        color: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <h1>Documentation 7 · Simulation Pipeline &amp; Runtime</h1>
    <p>
      This chapter describes what happens when you click “Apply Preset” or
      adjust the controls. Understanding the lifecycle of a network build helps
      you trace issues, profile performance, and extend the engine responsibly.
    </p>

    <h2>High-Level Flow</h2>
    <div class="step">
      <h3>Step 1 · Template Resolution</h3>
      <p>
        When a preset is selected, <code>SNN_REGISTRY.getTemplateForPreset</code>
        returns a normalized template object. This passes through
        <code>SNN_CONFIG_IO.normalizeTemplate</code>, ensuring clusters and
        connections have consistent structure.
      </p>
    </div>
    <div class="step">
      <h3>Step 2 · Cluster Metadata</h3>
      <p>
        <code>createNetworkFromTemplate</code> iterates over each cluster
        definition, building metadata objects that store labels, neuron groups,
        and references for the inspector. Cluster positions are arranged on a
        grid using the orbit camera spacing constants.
      </p>
    </div>
    <div class="step">
      <h3>Step 3 · Neuron Construction</h3>
      <p>
        For every neuron group (e.g., <code>{ "preset": "pyramidal", "count": 120 }</code>),
        the engine instantiates that many neuron objects with shared biophysical
        defaults. Each neuron stores links to its cluster metadata, type labels,
        glyph key, and connection list.
      </p>
    </div>
    <div class="step">
      <h3>Step 4 · Connectivity</h3>
      <p>
        Internal and inter-cluster connectivity rules are expanded into actual
        edges. Probabilities are multiplied by UI slider scales, and weights are
        jittered slightly to avoid total uniformity. Each edge holds references
        to the source/target neuron and the computed weight.
      </p>
    </div>
    <div class="step">
      <h3>Step 5 · Simulation Loop</h3>
      <p>
        The animation loop (requestAnimationFrame) calls
        <code>updateNetwork</code>, which steps the spiking simulation according
        to <code>this.state.speed</code>. Neurons integrate inputs, apply leak,
        test thresholds, and fire spikes that enqueue voltage updates for their
        targets. Visual pulses and spike history arrays are updated here.
      </p>
    </div>

    <h2>Key Functions</h2>
    <ul>
      <li><code>createNetwork</code> &mdash; Entry point when procedural sliders change.</li>
      <li><code>createNetworkFromTemplate</code> &mdash; Builds networks from manifest templates.</li>
      <li><code>updateNetwork</code> &mdash; Advances the simulation each frame.</li>
      <li><code>render</code> (within <code>drawScene</code>) &mdash; Projects neurons to 2D and draws glyphs.</li>
    </ul>

    <h2>Determinism vs Randomness</h2>
    <p>
      Neuron placement, initial voltages, and jittered weights introduce randomness
      for visual variety. For reproducible runs you can seed <code>Math.random</code>
      at the top of <code>createNetworkFromTemplate</code>. This is useful when
      capturing screenshots or running tests that compare network statistics.
    </p>

    <h2>Performance Notes</h2>
    <ul>
      <li>Networks over ~2,000 neurons can impact frame rate on integrated GPUs.</li>
      <li>
        Enabling “Show Weights” adds DOM nodes for each selected neuron; disable
        it when profiling.
      </li>
      <li>
        The simulation loop batches spikes per frame. Extreme firing rates may
        saturate and appear continuous—adjust the threshold slider to compensate.
      </li>
    </ul>

    <div class="callout">
      <strong>Instrumenting the Loop</strong>
      <p>
        Enable the debug overlay via <code>VITE_ENABLE_DEBUG_OVERLAY=true</code> to
        display frame timing, neuron counts, and spike statistics. The overlay
        is lightweight and invaluable when extending the runtime.
      </p>
    </div>

    <h2>Next Chapter</h2>
    <p>
      Continue to <em>Documentation 8 · Importing &amp; Exporting Atlas Data</em> to
      learn how templates are validated, versioned, and round-tripped through the UI.
    </p>
  </body>
</html>
